# Docker Compose configuration for AEFL federated learning clients.
# Launches five roles: roadside, vehicle, sensor, camera, bus.
# Dataset name is provided at runtime via: export DATASET=<name>.

x-common: &common
  build:
    context: .
    dockerfile: Dockerfile

  working_dir: /app
  network_mode: host
  restart: "no"

  volumes:
    - .:/app
    - ~/.aws:/home/aefluser/.aws:ro

  environment: &common-env
    AWS_REGION: "us-east-1"
    S3_BUCKET: "aefl"
    DATASET: "${DATASET}"
    FL_MODE: "${FL_MODE}"
    FL_ROUNDS: 20
    BATCH_SIZE: 64
    LOCAL_EPOCHS: 1
    LR: 0.001
    HIDDEN_SIZE: 64

    # default values (can be overridden)
    DEVICE_POWER_WATTS: 3.5
    NET_J_PER_MB: 0.6

    DP_ENABLED: "false"
    DP_SIGMA: 0.01

    COMPRESSION_ENABLED: "false"
    COMPRESSION_MODE: "sparsify"
    COMPRESSION_SPARSITY: 0.5
    COMPRESSION_K_FRAC: 0.1

services:

  client_roadside:
    <<: *common
    container_name: client_roadside
    environment:
      <<: *common-env
      CLIENT_ROLE: "roadside"
      DEVICE_POWER_WATTS: 2.0 # low power roadside sensor
    command: [ "python", "-u", "-m", "src.fl.client" ]

  client_vehicle:
    <<: *common
    container_name: client_vehicle
    environment:
      <<: *common-env
      CLIENT_ROLE: "vehicle"
      DEVICE_POWER_WATTS: 4.0 # medium/high vehicular unit
    command: [ "python", "-u", "-m", "src.fl.client" ]

  client_sensor:
    <<: *common
    container_name: client_sensor
    environment:
      <<: *common-env
      CLIENT_ROLE: "sensor"
      DEVICE_POWER_WATTS: 2.5 # embedded IoT sensor
    command: [ "python", "-u", "-m", "src.fl.client" ]

  client_camera:
    <<: *common
    container_name: client_camera
    environment:
      <<: *common-env
      CLIENT_ROLE: "camera"
      DEVICE_POWER_WATTS: 5.0 # high-power camera node
    command: [ "python", "-u", "-m", "src.fl.client" ]

  client_bus:
    <<: *common
    container_name: client_bus
    environment:
      <<: *common-env
      CLIENT_ROLE: "bus"
      DEVICE_POWER_WATTS: 4.0 # medium/high-powered vehicle system
    command: [ "python", "-u", "-m", "src.fl.client" ]
